# TESTING

Questo documento descrive la strategia di testing del progetto, come eseguire i test
in locale (unit e integrazione), come abilitare i test d'integrazione basati su
Testcontainers/Postgres, e come risolvere i problemi più comuni.

## Indice
- Scopo e contesto
- Tipi di test presenti
- Eseguire i test unitari (veloce)
- Eseguire i test d'integrazione (Testcontainers)
# TESTING

This document describes the testing strategy for the project, how to run tests
locally (unit and integration), how to enable Testcontainers/Postgres-based
integration tests, and common troubleshooting steps.

## Table of contents
- Purpose and context
- Types of tests included
- Running unit tests (fast)
- Running integration tests (Testcontainers)
- Running tests using Docker Compose (external DB)
- Important environment variables for tests
- Troubleshooting: common issues and fixes

## Purpose and context

This project is a Spring Boot demo that showcases:

- JWT-based authentication (access tokens) with persistent refresh tokens
- Roles and authorization (ROLE_USER, ROLE_ADMIN, ROLE_MANAGER)
- Persistence on PostgreSQL with Flyway migrations
- Caching with Caffeine
- OpenAPI documentation, Actuator, and Logback with MDC

Tests are organized as:

- Unit tests: fast, no external dependencies (Mockito for mocking)
- Integration tests (E2E): verify the full HTTP flow using Testcontainers (start a
  temporary PostgreSQL container and run Flyway migrations)

## Types of tests included

- `it.alf.springsecurity.*Test` — Unit tests for services, utilities and filters
- `it.alf.springsecurity.integration.*` — End-to-end integration tests (Testcontainers)

## Running unit tests (fast)

To run unit tests only (fast, no Docker required):

```pwsh
cd 'C:/Git/PROGETTI_ALF/VARI/Spring-Security-Demo'
mvn -DskipTests=false -Dtest="**/*Test" test
```

Some integration test placeholders are disabled by default with `@Disabled`. Read
the next section before enabling integration tests.

## Running integration tests (Testcontainers)

Integration tests use Testcontainers to start a temporary Postgres instance and
apply Flyway migrations. Requirements:

- Docker running on the development machine
- At least ~2GB free disk space for temporary containers

To enable and run the integration tests:

1. Remove or uncomment `@Disabled` in `src/test/java/it/alf/springsecurity/integration/AuthIntegrationTest.java`
2. Run integration tests with Maven:

```pwsh
cd 'C:/Git/PROGETTI_ALF/VARI/Spring-Security-Demo'
mvn -DskipTests=false -Dgroups=integration test
# or run all tests (unit + integration)
mvn -DskipTests=false clean verify
```

Notes:

- Testcontainers will automatically configure `spring.datasource.*` properties
  via `DynamicPropertySource`, so no additional configuration is usually required.
- If you prefer to use an external DB (via docker-compose), see the next section.

## Running tests using Docker Compose (external DB)

Alternatively, start a local Postgres instance using the provided `docker-compose.yml`
and point the application to that database.

1. Start required services:

```pwsh
cd 'C:/Git/PROGETTI_ALF/VARI/Spring-Security-Demo'
docker compose up -d postgres
```

2. Set the test profile or configure the environment variables before running tests
(PowerShell example):

```pwsh
$env:SPRING_PROFILES_ACTIVE='test'
$env:SPRING_DATASOURCE_URL='jdbc:postgresql://localhost:5432/testdb'
$env:SPRING_DATASOURCE_USERNAME='postgres'
$env:SPRING_DATASOURCE_PASSWORD='postgres'
mvn -DskipTests=false clean verify
```

## Important environment variables for tests

- `JWT_SECRET` / `jwt.secret`: the HMAC key used in tests must be at least 32 bytes
  (for HS256). A long default value is present in `application.yml` for local testing.
  In production, provide the key via environment variables or a secret manager.
- `SPRING_PROFILES_ACTIVE`: activates a profile (`dev`, `test`, `prod`)
- DB URL / credentials (if not using Testcontainers)

## Troubleshooting: common issues and fixes

- WeakKeyException (JJWT): if the app fails at startup with
  "The specified key byte array is 128 bits which is not secure enough...",
  configure a longer JWT key (>32 bytes) using `JWT_SECRET` or in `application.yml`.
- Flyway / DB connection refused: integration tests and Flyway migrations require
  DB access. If running without Docker/Testcontainers, ensure Postgres is listening
  on the correct port (e.g. 5433 for the test profile) or use
  `docker compose up -d postgres`.
- Testcontainers not starting: ensure Docker Desktop is running and the Testcontainers
  version is compatible with your Docker installation.
- Tests expecting `ROLE_USER`: some registration flows expect the `ROLE_USER` role
  to exist in the DB (the initial Flyway script inserts roles).

## Notes for CI (GitHub Actions)

The repository CI pipeline runs Maven `clean verify` and can be extended to run
integration tests with Testcontainers (requires a runner that supports Docker).
Alternatively, use hosted Postgres services for CI jobs.

## Contact and reference

For environment-specific issues, include Maven logs (`-e` or `-X`) and Docker output
when opening an issue or reporting a failing test. See `ARCHITECTURE.md` for more
context about the authentication flow and design choices useful for debugging.

## Quick commands

- Run all tests: `mvn test`
- Full verification: `mvn -DskipTests=false clean verify`

## Testcontainers and coverage

- Integration tests start a PostgreSQL container and use the `test` profile.
- JaCoCo is configured; CI can be set to fail the job if coverage drops below a defined threshold.

  In production, provide the key via environment variables or a secret manager.
- `SPRING_PROFILES_ACTIVE`: activates a profile (`dev`, `test`, `prod`)
- DB URL / credentials (if not using Testcontainers)

## Troubleshooting: common issues and fixes

- WeakKeyException (JJWT): if the app fails at startup with
  "The specified key byte array is 128 bits which is not secure enough...",
  configure a longer JWT key (>32 bytes) using `JWT_SECRET` or in `application.yml`.
- Flyway / DB connection refused: integration tests and Flyway migrations require
  DB access. If running without Docker/Testcontainers, ensure Postgres is listening
  on the correct port (e.g. 5433 for the test profile) or use
  `docker compose up -d postgres`.
- Testcontainers not starting: ensure Docker Desktop is running and the Testcontainers
  version is compatible with your Docker installation.
- Tests expecting `ROLE_USER`: some registration flows expect the `ROLE_USER` role
  to exist in the DB (the initial Flyway script inserts roles).

## Notes for CI (GitHub Actions)

The repository CI pipeline runs Maven `clean verify` and can be extended to run
integration tests with Testcontainers (requires a runner that supports Docker).
Alternatively, use hosted Postgres services for CI jobs.

## Contact and reference

For environment-specific issues, include Maven logs (`-e` or `-X`) and Docker output
when opening an issue or reporting a failing test. See `ARCHITECTURE.md` for more
context about the authentication flow and design choices useful for debugging.

## Quick commands

- Run all tests: `mvn test`
- Full verification: `mvn -DskipTests=false clean verify`

## Testcontainers and coverage

- Integration tests start a PostgreSQL container and use the `test` profile.
- JaCoCo is configured; CI can be set to fail the job if coverage drops below a defined threshold.
